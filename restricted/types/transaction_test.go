// Copyright 2014 The go-ethereum Authors
// This file is part of the go-ethereum library.
//
// The go-ethereum library is free software: you can redistribute it and/or modify
// it under the terms of the GNU Lesser General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// The go-ethereum library is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
// GNU Lesser General Public License for more details.
//
// You should have received a copy of the GNU Lesser General Public License
// along with the go-ethereum library. If not, see <http://www.gnu.org/licenses/>.

package types

import (
	"bytes"
	"crypto/ecdsa"
	"encoding/hex"
	"encoding/json"
	"fmt"
	"math/big"
	// "math/rand"
	"reflect"
	"testing"
	// "time"

	"github.com/openrelayxyz/plugeth-utils/core"
	"github.com/openrelayxyz/plugeth-utils/restricted/crypto"
	"github.com/openrelayxyz/plugeth-utils/restricted/hexutil"
	"github.com/openrelayxyz/plugeth-utils/restricted/rlp"
)

func fromHex(data string) []byte {
	d, _ := hex.DecodeString(data)
	return d
}

// The values in those tests are from the Transaction Tests
// at github.com/ethereum/tests.
var (
	testAddr = core.HexToAddress("b94f5374fce5edbc8e2a8697c15331677e6ebf0b")

	emptyTx = NewTransaction(
		0,
		core.HexToAddress("095e7baea6a6c7c4c2dfeb977efac326af552d87"),
		big.NewInt(0), 0, big.NewInt(0),
		nil,
	)

	rightvrsTx, _ = NewTransaction(
		3,
		testAddr,
		big.NewInt(10),
		2000,
		big.NewInt(1),
		fromHex("5544"),
	).WithSignature(
		HomesteadSigner{},
		fromHex("98ff921201554726367d2be8c804a7ff89ccf285ebc57dff8ae4c44b9c19ac4a8887321be575c8095f789dd4c743dfe42c1820f9231f98a962b210e3ac2452a301"),
	)

	emptyEip2718Tx = NewTx(&AccessListTx{
		ChainID:  big.NewInt(1),
		Nonce:    3,
		To:       &testAddr,
		Value:    big.NewInt(10),
		Gas:      25000,
		GasPrice: big.NewInt(1),
		Data:     fromHex("5544"),
	})

	signedEip2718Tx, _ = emptyEip2718Tx.WithSignature(
		NewEIP2930Signer(big.NewInt(1)),
		fromHex("c9519f4f2b30335884581971573fadf60c6204f59a911df35ee8a540456b266032f1e8e2c5dd761f9e4f88f41c8310aeaba26a8bfcdacfedfa12ec3862d3752101"),
	)
)

func TestDecodeEmptyTypedTx(t *testing.T) {
	input := []byte{0x80}
	var tx Transaction
	err := rlp.DecodeBytes(input, &tx)
	if err != errShortTypedTx {
		t.Fatal("wrong error:", err)
	}
}

func TestTransactionSigHash(t *testing.T) {
	var homestead HomesteadSigner
	if homestead.Hash(emptyTx) != core.HexToHash("c775b99e7ad12f50d819fcd602390467e28141316969f4b57f0626f74fe3b386") {
		t.Errorf("empty transaction hash mismatch, got %x", emptyTx.Hash())
	}
	if homestead.Hash(rightvrsTx) != core.HexToHash("fe7a79529ed5f7c3375d06b26b186a8644e0e16c373d7a12be41c62d6042b77a") {
		t.Errorf("RightVRS transaction hash mismatch, got %x", rightvrsTx.Hash())
	}
}

func TestTransactionEncode(t *testing.T) {
	txb, err := rlp.EncodeToBytes(rightvrsTx)
	if err != nil {
		t.Fatalf("encode error: %v", err)
	}
	should := fromHex("f86103018207d094b94f5374fce5edbc8e2a8697c15331677e6ebf0b0a8255441ca098ff921201554726367d2be8c804a7ff89ccf285ebc57dff8ae4c44b9c19ac4aa08887321be575c8095f789dd4c743dfe42c1820f9231f98a962b210e3ac2452a3")
	if !bytes.Equal(txb, should) {
		t.Errorf("encoded RLP mismatch, got %x", txb)
	}
}

func TestEIP2718TransactionSigHash(t *testing.T) {
	s := NewEIP2930Signer(big.NewInt(1))
	if s.Hash(emptyEip2718Tx) != core.HexToHash("49b486f0ec0a60dfbbca2d30cb07c9e8ffb2a2ff41f29a1ab6737475f6ff69f3") {
		t.Errorf("empty EIP-2718 transaction hash mismatch, got %x", s.Hash(emptyEip2718Tx))
	}
	if s.Hash(signedEip2718Tx) != core.HexToHash("49b486f0ec0a60dfbbca2d30cb07c9e8ffb2a2ff41f29a1ab6737475f6ff69f3") {
		t.Errorf("signed EIP-2718 transaction hash mismatch, got %x", s.Hash(signedEip2718Tx))
	}
}

// This test checks signature operations on access list transactions.
func TestEIP2930Signer(t *testing.T) {

	var (
		key, _  = crypto.HexToECDSA("b71c71a67e1177ad4e901695e1b4b9ee17ae16c6668d313eac2f96dbcda3f291")
		keyAddr = crypto.PubkeyToAddress(key.PublicKey)
		signer1 = NewEIP2930Signer(big.NewInt(1))
		signer2 = NewEIP2930Signer(big.NewInt(2))
		tx0     = NewTx(&AccessListTx{Nonce: 1})
		tx1     = NewTx(&AccessListTx{ChainID: big.NewInt(1), Nonce: 1})
		tx2, _  = SignNewTx(key, signer2, &AccessListTx{ChainID: big.NewInt(2), Nonce: 1})
	)

	tests := []struct {
		tx             *Transaction
		signer         Signer
		wantSignerHash core.Hash
		wantSenderErr  error
		wantSignErr    error
		wantHash       core.Hash // after signing
	}{
		{
			tx:             tx0,
			signer:         signer1,
			wantSignerHash: core.HexToHash("846ad7672f2a3a40c1f959cd4a8ad21786d620077084d84c8d7c077714caa139"),
			wantSenderErr:  ErrInvalidChainId,
			wantHash:       core.HexToHash("1ccd12d8bbdb96ea391af49a35ab641e219b2dd638dea375f2bc94dd290f2549"),
		},
		{
			tx:             tx1,
			signer:         signer1,
			wantSenderErr:  ErrInvalidSig,
			wantSignerHash: core.HexToHash("846ad7672f2a3a40c1f959cd4a8ad21786d620077084d84c8d7c077714caa139"),
			wantHash:       core.HexToHash("1ccd12d8bbdb96ea391af49a35ab641e219b2dd638dea375f2bc94dd290f2549"),
		},
		{
			// This checks what happens when trying to sign an unsigned tx for the wrong chain.
			tx:             tx1,
			signer:         signer2,
			wantSenderErr:  ErrInvalidChainId,
			wantSignerHash: core.HexToHash("367967247499343401261d718ed5aa4c9486583e4d89251afce47f4a33c33362"),
			wantSignErr:    ErrInvalidChainId,
		},
		{
			// This checks what happens when trying to re-sign a signed tx for the wrong chain.
			tx:             tx2,
			signer:         signer1,
			wantSenderErr:  ErrInvalidChainId,
			wantSignerHash: core.HexToHash("846ad7672f2a3a40c1f959cd4a8ad21786d620077084d84c8d7c077714caa139"),
			wantSignErr:    ErrInvalidChainId,
		},
	}

	for i, test := range tests {
		sigHash := test.signer.Hash(test.tx)
		if sigHash != test.wantSignerHash {
			t.Errorf("test %d: wrong sig hash: got %x, want %x", i, sigHash, test.wantSignerHash)
		}
		sender, err := Sender(test.signer, test.tx)
		if err != test.wantSenderErr {
			t.Errorf("test %d: wrong Sender error %q", i, err)
		}
		if err == nil && sender != keyAddr {
			t.Errorf("test %d: wrong sender address %x", i, sender)
		}
		signedTx, err := SignTx(test.tx, test.signer, key)
		if err != test.wantSignErr {
			t.Fatalf("test %d: wrong SignTx error %q", i, err)
		}
		if signedTx != nil {
			if signedTx.Hash() != test.wantHash {
				t.Errorf("test %d: wrong tx hash after signing: got %x, want %x", i, signedTx.Hash(), test.wantHash)
			}
		}
	}
}

func TestEIP2718TransactionEncode(t *testing.T) {
	// RLP representation
	{
		have, err := rlp.EncodeToBytes(signedEip2718Tx)
		if err != nil {
			t.Fatalf("encode error: %v", err)
		}
		want := fromHex("b86601f8630103018261a894b94f5374fce5edbc8e2a8697c15331677e6ebf0b0a825544c001a0c9519f4f2b30335884581971573fadf60c6204f59a911df35ee8a540456b2660a032f1e8e2c5dd761f9e4f88f41c8310aeaba26a8bfcdacfedfa12ec3862d37521")
		if !bytes.Equal(have, want) {
			t.Errorf("encoded RLP mismatch, got %x", have)
		}
	}
	// Binary representation
	{
		have, err := signedEip2718Tx.MarshalBinary()
		if err != nil {
			t.Fatalf("encode error: %v", err)
		}
		want := fromHex("01f8630103018261a894b94f5374fce5edbc8e2a8697c15331677e6ebf0b0a825544c001a0c9519f4f2b30335884581971573fadf60c6204f59a911df35ee8a540456b2660a032f1e8e2c5dd761f9e4f88f41c8310aeaba26a8bfcdacfedfa12ec3862d37521")
		if !bytes.Equal(have, want) {
			t.Errorf("encoded RLP mismatch, got %x", have)
		}
	}
}

func decodeTx(data []byte) (*Transaction, error) {
	var tx Transaction
	t, err := &tx, rlp.Decode(bytes.NewReader(data), &tx)
	return t, err
}

func defaultTestKey() (*ecdsa.PrivateKey, core.Address) {
	key, _ := crypto.HexToECDSA("45a915e4d060149eb4365960e6a7a45f334393093061116b197e3240065ff2d8")
	addr := crypto.PubkeyToAddress(key.PublicKey)
	return key, addr
}

func TestRecipientEmpty(t *testing.T) {
	_, addr := defaultTestKey()
	tx, err := decodeTx(fromHex("f8498080808080011ca09b16de9d5bdee2cf56c28d16275a4da68cd30273e2525f3959f5d62557489921a0372ebd8fb3345f7db7b5a86d42e24d36e983e259b0664ceb8c227ec9af572f3d"))
	if err != nil {
		t.Fatal(err)
	}

	from, err := Sender(HomesteadSigner{}, tx)
	if err != nil {
		t.Fatal(err)
	}
	if addr != from {
		t.Fatal("derived address doesn't match")
	}
}

func TestRecipientNormal(t *testing.T) {
	_, addr := defaultTestKey()

	tx, err := decodeTx(fromHex("f85d80808094000000000000000000000000000000000000000080011ca0527c0d8f5c63f7b9f41324a7c8a563ee1190bcbf0dac8ab446291bdbf32f5c79a0552c4ef0a09a04395074dab9ed34d3fbfb843c2f2546cc30fe89ec143ca94ca6"))
	if err != nil {
		t.Fatal(err)
	}

	from, err := Sender(HomesteadSigner{}, tx)
	if err != nil {
		t.Fatal(err)
	}
	if addr != from {
		t.Fatal("derived address doesn't match")
	}
}

// func TestTransactionPriceNonceSortLegacy(t *testing.T) {
// 	testTransactionPriceNonceSort(t, nil)
// }

// func TestTransactionPriceNonceSort1559(t *testing.T) {
// 	testTransactionPriceNonceSort(t, big.NewInt(0))
// 	testTransactionPriceNonceSort(t, big.NewInt(5))
// 	testTransactionPriceNonceSort(t, big.NewInt(50))
// }

// Tests that transactions can be correctly sorted according to their price in
// decreasing order, but at the same time with increasing nonces when issued by
// the same account.
// func testTransactionPriceNonceSort(t *testing.T, baseFee *big.Int) {
// 	// Generate a batch of accounts to start with
// 	keys := make([]*ecdsa.PrivateKey, 25)
// 	for i := 0; i < len(keys); i++ {
// 		keys[i], _ = crypto.GenerateKey()
// 	}
// 	signer := LatestSignerForChainID(big.NewInt(1))

// 	// Generate a batch of transactions with overlapping values, but shifted nonces
// 	groups := map[core.Address]Transactions{}
// 	expectedCount := 0
// 	for start, key := range keys {
// 		addr := crypto.PubkeyToAddress(key.PublicKey)
// 		count := 25
// 		for i := 0; i < 25; i++ {
// 			var tx *Transaction
// 			gasFeeCap := rand.Intn(50)
// 			if baseFee == nil {
// 				tx = NewTx(&LegacyTx{
// 					Nonce:    uint64(start + i),
// 					To:       &core.Address{},
// 					Value:    big.NewInt(100),
// 					Gas:      100,
// 					GasPrice: big.NewInt(int64(gasFeeCap)),
// 					Data:     nil,
// 				})
// 			} else {
// 				tx = NewTx(&DynamicFeeTx{
// 					Nonce:     uint64(start + i),
// 					To:        &core.Address{},
// 					Value:     big.NewInt(100),
// 					Gas:       100,
// 					GasFeeCap: big.NewInt(int64(gasFeeCap)),
// 					GasTipCap: big.NewInt(int64(rand.Intn(gasFeeCap + 1))),
// 					Data:      nil,
// 				})
// 				if count == 25 && int64(gasFeeCap) < baseFee.Int64() {
// 					count = i
// 				}
// 			}
// 			tx, err := SignTx(tx, signer, key)
// 			if err != nil {
// 				t.Fatalf("failed to sign tx: %s", err)
// 			}
// 			groups[addr] = append(groups[addr], tx)
// 		}
// 		expectedCount += count
// 	}
// 	// Sort the transactions and cross check the nonce ordering
// 	txset := NewTransactionsByPriceAndNonce(signer, groups, baseFee)

// 	txs := Transactions{}
// 	for tx := txset.Peek(); tx != nil; tx = txset.Peek() {
// 		txs = append(txs, tx)
// 		txset.Shift()
// 	}
// 	if len(txs) != expectedCount {
// 		t.Errorf("expected %d transactions, found %d", expectedCount, len(txs))
// 	}
// 	for i, txi := range txs {
// 		fromi, _ := Sender(signer, txi)

// 		// Make sure the nonce order is valid
// 		for j, txj := range txs[i+1:] {
// 			fromj, _ := Sender(signer, txj)
// 			if fromi == fromj && txi.Nonce() > txj.Nonce() {
// 				t.Errorf("invalid nonce ordering: tx #%d (A=%x N=%v) < tx #%d (A=%x N=%v)", i, fromi[:4], txi.Nonce(), i+j, fromj[:4], txj.Nonce())
// 			}
// 		}
// 		// If the next tx has different from account, the price must be lower than the current one
// 		if i+1 < len(txs) {
// 			next := txs[i+1]
// 			fromNext, _ := Sender(signer, next)
// 			tip, err := txi.EffectiveGasTip(baseFee)
// 			nextTip, nextErr := next.EffectiveGasTip(baseFee)
// 			if err != nil || nextErr != nil {
// 				t.Errorf("error calculating effective tip")
// 			}
// 			if fromi != fromNext && tip.Cmp(nextTip) < 0 {
// 				t.Errorf("invalid gasprice ordering: tx #%d (A=%x P=%v) < tx #%d (A=%x P=%v)", i, fromi[:4], txi.GasPrice(), i+1, fromNext[:4], next.GasPrice())
// 			}
// 		}
// 	}
// }

// Tests that if multiple transactions have the same price, the ones seen earlier
// are prioritized to avoid network spam attacks aiming for a specific ordering.
// func TestTransactionTimeSort(t *testing.T) {
// 	// Generate a batch of accounts to start with
// 	keys := make([]*ecdsa.PrivateKey, 5)
// 	for i := 0; i < len(keys); i++ {
// 		keys[i], _ = crypto.GenerateKey()
// 	}
// 	signer := HomesteadSigner{}

// 	// Generate a batch of transactions with overlapping prices, but different creation times
// 	groups := map[core.Address]Transactions{}
// 	for start, key := range keys {
// 		addr := crypto.PubkeyToAddress(key.PublicKey)

// 		tx, _ := SignTx(NewTransaction(0, core.Address{}, big.NewInt(100), 100, big.NewInt(1), nil), signer, key)
// 		tx.time = time.Unix(0, int64(len(keys)-start))

// 		groups[addr] = append(groups[addr], tx)
// 	}
// 	// Sort the transactions and cross check the nonce ordering
// 	txset := NewTransactionsByPriceAndNonce(signer, groups, nil)

// 	txs := Transactions{}
// 	for tx := txset.Peek(); tx != nil; tx = txset.Peek() {
// 		txs = append(txs, tx)
// 		txset.Shift()
// 	}
// 	if len(txs) != len(keys) {
// 		t.Errorf("expected %d transactions, found %d", len(keys), len(txs))
// 	}
// 	for i, txi := range txs {
// 		fromi, _ := Sender(signer, txi)
// 		if i+1 < len(txs) {
// 			next := txs[i+1]
// 			fromNext, _ := Sender(signer, next)

// 			if txi.GasPrice().Cmp(next.GasPrice()) < 0 {
// 				t.Errorf("invalid gasprice ordering: tx #%d (A=%x P=%v) < tx #%d (A=%x P=%v)", i, fromi[:4], txi.GasPrice(), i+1, fromNext[:4], next.GasPrice())
// 			}
// 			// Make sure time order is ascending if the txs have the same gas price
// 			if txi.GasPrice().Cmp(next.GasPrice()) == 0 && txi.time.After(next.time) {
// 				t.Errorf("invalid received time ordering: tx #%d (A=%x T=%v) > tx #%d (A=%x T=%v)", i, fromi[:4], txi.time, i+1, fromNext[:4], next.time)
// 			}
// 		}
// 	}
// }

func TestDecodeBlockWithBlobTransaction(t *testing.T) {
	blockRLP, _ := hexutil.Decode("0xf9395ff90247a09f5d5bfbb7e6b6a22e464afcffc67337cf18fd7975b100583dc4f30ad0049705a01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d4934794f97e180c050e5ab072211ad2c213eb5aee4df134a032f2d1838907e3dfb580a933d41c183dba785f45c0904c6da6521f79d1054a9ca0ed003ed5692876754c0ec678030d4734c68eac27413e17861cbc9f6cfe64f833a04f68be4b2adc6a5661d5de13b44ff8edf09f02965e30df085308725a6e93fcefb901000000000a0000004000040082014005c4401c004248000c4000020100840408420000a000004000247a010008000020482140009000002001440043002024001000104060ac00800c0090020f820202805000000200060000020040080080000042060000020020080048180040042800300004808010054800204810080820028a02030020000002000000008400008000400002861082000000802000804100020810d02020100000019102c04c80000000020280000000000400060040820a9202c9220000000000040000400400020000020004000000000114000000e400019022080024004800000020200020102000000008184200010080000000088080839e83a88401c9c3808377539f8465a78a3880a0720fa6e9c9fd9765cf411d26530a4ef8eba4363f7265764e5d9556e1fff172b888000000000000000009a0451d5ff078d2409bc312ec614ae3b56d0a7d3dd641b274a10cd60ad8d91f28d4830c00008404360000a07ea8229f339bdc184a7992883b8117c0d4252d444e61ee87d7c7c533a55fb599f934deb8b903f8b6053d850165a0bc00858bb2c97000825208944f56ffc63c28b72f79b02e91f11a4707bac4043c8080c0858bb2c97000f842a00155acead2ea1da3a7f6e9c743f4d81b1cd9f5a3382e657aa4025837e2b1651fa0019db7c3b9244969140c36c20cdcc71a821e2a995714c1ec2169f3ebd63c648280a00567aaceaed2303b577178069e5f4bfdd70d445e9eff8e63f9f0a33de98dd782a060e39ff4d29ce28325e3b48707bb8dd170ed3671428a62efcab9812555eb6db1b87802f875058319056b847735940085e8d4a5100082520894673757e4fc512b82e98a8727bf4ae0897a61c1ba874f6734e2bae00080c001a05d773b4cb23f8479f7447d16193f38b1afac4252f528d46378258840252151b2a00bb81f6d32aeb8377b0a61603b6da33362208c01d01a3d371b0d40b51be23883b8d903f8d6053a8477359400852e90edd0008252089456272f6932e6ae0116d270a2e919d20d3052f2068080c0852e90edd000f863a001f2035c3530118b4869faafe24abe0dafde446d165346a109caacabfe352b6aa0019ff4fc0675dba34af6e31c4b465cdb089a022ae0626678ebd5b0d1dcb49f25a001034c8ac13ef9d2c68c219288cdb648c4cb625e3d752e6d91712d6043d9e58401a0f01a4129267e85ea2d6bcbd783e19ba5fb6c749f96f4d0d99aa944eedb48f06aa0426a2645bee4a26b280a8c34ea47b2dbcc381fee693f082be5f1df033ba5e65fb89603f893053e8477359400852e90edd00082520894184a8b43dace281e8afd9aeb143f81396fa73ce78080c0852e90edd000e1a00115aae31589fb81727b78393ef6fcc71d652d75d507cfe0d3f2c634120fccd201a01131647af6ea914a5d0e2bdb7e23608acea0893fa7907af9f9f7acf990579ca5a03f171316bd763a0fdff9c467335182cc2e4143e0443333350b882e21b9126c46b87602f87305820eb58459777140845977714b82520894c38eb1ebfe1a2d73cacd1cc1901096e952e16c7087038d7ea4c6800080c080a0343232dc3156fde510ceff4b94f77e335edb33e5cc9d4c622414bf6e2155f6e0a05e728d1466c9578d55468021b9585ebacf88c3b916c36e8435fce6a917db5c37b87502f872058213be8459777140845977714b82520894603064f31bc93d7178297ac9c5df42dcbb3579f287038d7ea4c6800080c001a0094b515aff27e094e32a00f3abdfc5de8ea076eb63facf399254abec7240d59c9f41ca357b0211d427b588a3ca1147125e2630f9875724970631a99f8fc81dedb89402f891058280008459682f00849502f90e83010101942207f22d3aa349604e7e91c24c6222d8fd8e6b2880a453556559000000000000000000000000000000000000000000000000002386f26fc10000c080a00b30b78f3d953d6ac380c41c0e0d5f49a474263453470c7bf3afa8e482f24ea6a0194f33011106988352fe57c520401d25de4d9c14b329c4bdab7970a0e4fa6677b89402f891058280018459682f00849502f90e83010101942207f22d3aa349604e7e91c24c6222d8fd8e6b2880a453556559000000000000000000000000000000000000000000000000002386f26fc10000c080a0f21cd9dffe9b60491f067a52d8116b08e3c26e2a51eb99cb92c3403a7e80b19fa05af72cd08e647d9341ae8e8dfc16938c837cf545807c688a14e2ee3938af44c4b89402f891058280028459682f00849502f90e83010101942207f22d3aa349604e7e91c24c6222d8fd8e6b2880a453556559000000000000000000000000000000000000000000000000002386f26fc10000c080a06e10866904df2885196c9e4881a8efb2e256022f406ae585f68e00a9dbbfebaea0734d614c6b90084f6b8d745e2808b8449b97a655bbd84a43463f317dfe8592b1b89402f891058280038459682f00849502f90e83010101942207f22d3aa349604e7e91c24c6222d8fd8e6b2880a453556559000000000000000000000000000000000000000000000000002386f26fc10000c001a029d1ec9b519ef969deb8d18e0eebeb106231ff5b933fe055835b5f3c4a44704ea05b3e45822a3bae69889e3272a61244f50ca17eb347b2d4df53961b79f96a96e5b89402f891058280048459682f00849502f90e83010101942207f22d3aa349604e7e91c24c6222d8fd8e6b2880a453556559000000000000000000000000000000000000000000000000002386f26fc10000c080a08e7d850b107aeb407f782dafc719b2d42772c34206fe2cfae8e74bf23e8c1434a05e3631efd45154de0ccbd3c3726fedbb06bbd3743f5a4e1bc618e4f8bd5b2a1fb89402f891058280058459682f00849502f90e83010101942207f22d3aa349604e7e91c24c6222d8fd8e6b2880a453556559000000000000000000000000000000000000000000000000002386f26fc10000c080a0258f3613b16f79c9a6d5752f44ec16763bdbf1b62c8fbb1c74ef95a985c25695a07c6cb5749c0a0255fef6d3c4b0ff21a4d3f62d12455a84d94680b80bbfa32709b89402f891058280068459682f00849502f90e83010101942207f22d3aa349604e7e91c24c6222d8fd8e6b2880a453556559000000000000000000000000000000000000000000000000002386f26fc10000c080a09b49148abf2193c6e86817e04535af8647d9e514d7ba36154d807fa77678107aa033b191e0b624aa127280b363aac0e8a13b03247123fdbf2741c15a330082b19ab89402f891058280078459682f00849502f90e83010101942207f22d3aa349604e7e91c24c6222d8fd8e6b2880a453556559000000000000000000000000000000000000000000000000002386f26fc10000c080a01d32aae05e7215706120df8a97ee01cfab7bdc695fb01a96c57e590e825a162ca0304a623f458bf18b4db9fda8e29bd368b242e2fba2ff8416845a37f03c3ec030b89402f891058280088459682f00849502f90e83010101942207f22d3aa349604e7e91c24c6222d8fd8e6b2880a453556559000000000000000000000000000000000000000000000000002386f26fc10000c001a046d4e158bcfce2db140ac0f859698bea1d223e6fc1bf8c2cb6f7ce4d1ca37233a0266d196d0accffa65635c1192a7a07fbb184ea4d7c1a51c1c3036d8559118677b89402f891058280098459682f00849502f90e83010101942207f22d3aa349604e7e91c24c6222d8fd8e6b2880a453556559000000000000000000000000000000000000000000000000002386f26fc10000c001a076d4659fb1db2ed5e2d76e373e6d657e4a07e6d5f2fc510dec2b0f631f5f79f9a038dc41ecdd455dc11de6b7b11b423df1cb516a59c7dfb1bd3e79225426cce0ceb89402f8910582800a8459682f00849502f90e83010101942207f22d3aa349604e7e91c24c6222d8fd8e6b2880a453556559000000000000000000000000000000000000000000000000002386f26fc10000c080a01ea485c998d0f4c0fec174190117cae1e78f0e461c6ee4b099868ca4fc1e7e71a0675b3fd1a38c67a4de3f002467d5bd417a25e81d6330eb82c3ecda79d23c0b66b89402f8910582800b8459682f00849502f90e83010101942207f22d3aa349604e7e91c24c6222d8fd8e6b2880a453556559000000000000000000000000000000000000000000000000002386f26fc10000c001a08a2dbe57d69bcca9f964a0fbd86f88f437f6fee21a5d8c231bf46c9d4f1026a6a03fd2d6fe0f6b59c3778b0406dab901d2dce5587303b29a052162235515937e97b89402f8910582800c8459682f00849502f90e83010101942207f22d3aa349604e7e91c24c6222d8fd8e6b2880a453556559000000000000000000000000000000000000000000000000002386f26fc10000c001a04330f59b11628aca22d976cd459b020e853e1cb235c09002a20279994f02810ca046bad4f6d1ec3099849c2aafa983c758104b78fc1c9e0e5a9cd418a4cee66fcdb89402f8910582800d8459682f00849502f90e83010101942207f22d3aa349604e7e91c24c6222d8fd8e6b2880a453556559000000000000000000000000000000000000000000000000002386f26fc10000c080a0147f46d09999313cac0da9185daeff9ea6cfecbf55abf994b2e3ce0e5bdc6c91a061303754f6da08940e8e6e479ebde76f7e172679218a0bd146293681f4bedd13b89402f8910582800e8459682f00849502f90e83010101942207f22d3aa349604e7e91c24c6222d8fd8e6b2880a453556559000000000000000000000000000000000000000000000000002386f26fc10000c001a0fd75d606b4abe42cbeffd33cd00c42882e103cb810f36009102a50765c36aa69a02c7b4e6236f9919d2732095b9f1b25711ac60020eb956dfc6cb969565fac93b5b89402f8910582800f8459682f00849502f90e83010101942207f22d3aa349604e7e91c24c6222d8fd8e6b2880a453556559000000000000000000000000000000000000000000000000002386f26fc10000c001a037303f20633fb68ef8c6be42c6b2707e38622614b571a3c8f0c21d9d120e9e9ea01bd5071ff6578552f5cf9ea2167d9988df28fc7cded1345d4a70d7733d5297ccb89402f891058280108459682f00849502f90e83010101942207f22d3aa349604e7e91c24c6222d8fd8e6b2880a453556559000000000000000000000000000000000000000000000000002386f26fc10000c001a07e0981a0ff39481c9ae1ebdf9b23bfe5e8ae4ac3bcc09094de62288d5c6f590ca018c9812be5c9b51afd9997f42169ffe37a73bbec8859d4350509c7d9e539c037b9017802f901740583062da18459682f008459682f1483061a8094e592427a0aece92de3edee1f18e0157c0586156480b90104414bf389000000000000000000000000252d98fab648203aa33310721bbbddfa8f1b6587000000000000000000000000b4fbf271143f4fbf7b91a5ded31805e42b2208d600000000000000000000000000000000000000000000000000000000000027100000000000000000000000001ca793ddf8c5b049fb7285fb5de7ace8b70bb5aa0000000000000000000000000000000000000000000000000000000065a7a1740000000000000000000000000000000000000000000000011359fbe78dc394c800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c080a0389f0477bc9dc0a69ad5170d2578360318c9b03e071ecd6f6f5e8af153038942a0388a768a24dc82b3457a85806a06f5eeec48aa3321fc82c8816899ce253c9de3b89302f8900582cd6a8459682f008459682f128264cf94231055a0852d67c7107ad0d0dfeab60278fe6adc80a497ad09eb79730d5b44d531f2bde45b7f9364494a450cd8411338ea4b582970325d9863f7c001a048fc760da5349c81fc7753a1be89d280e8c63ed5141f480b6148e8d37dfd5a6ca0381a9b6850fa8f002d52aa9725aa11c3070636bbe331c729ac70a545a3532783b8b202f8af05018459682f008459682f0e82b8cb94b6806650a5345da2a7c119648944a52e7faa0eb180b844095ea7b3000000000000000000000000aaac6f9d407591909f1602762806e657eb12e21700000000000000000000000000000000000000000000003635c9adc5dea00000c080a0d7c3f46b7299be36a6704a6ed9db195fb7ac49ffaee0faa12867a8620cc2cdcda019917b35ede122ce7f47935c6381a2035c75b71caf77358d84997a9d9b900dcab89202f88f05028459682f008459682f0e83018a7b94aaac6f9d407591909f1602762806e657eb12e21780a4a694fc3a00000000000000000000000000000000000000000000003635c9adc5dea00000c080a0214f7349f2fafd81c11d4006e9774c105f0f246b82fa7e0bc02dcc900f3547c2a0477edd4d23d58645a85f6ac38d9fd4ca821d8dacb1928d5cb6cff4e7f0e55aa0b87402f87105058459682f008459682f0e825208944a9ea44bb79e5d32c1e2565142fa02f802510cad872386f26fc1000080c001a0a5e70890e6ed22d4a2b2ece6d7c80b8493071438e22dbb4c981d454786caf6f5a028a3f32a49d8b2fa9d2734fae7f75ad18cad9a3b8bfc9e28606d5ce211754dacb8d302f8d005058459682f008459682f0e8303dc2694779d1b5315df083e3f9e94cb495983500ba8e90780b864e7a050aa000000000000000000000000879944a8cb437a5f8061361f82a6d4eed59070b5000000000000000000000000178e141a0e3b34152f73ff610437a7bf9b83267a00000000000000000000000000000000000000000000000000537d202038c000c001a0a3e94a77f157cd934a22a11e3a462b1174100c460fed2d7a3c9c1076394e3f54a03e660ac82f3ee12d74cb8349c365459298c805dda0f327da18aa2e1cb71cdb25b8b202f8af05088459682f008459682f0e82b63e94fa4cf6f231f198ea682a0dffd9b34679af9da75480b844095ea7b30000000000000000000000009d2559a94a176c6e19fed9366448da6a9e8722300000000000000000000000000000000000000000000000052663ccab1e1c0000c080a0e82cb544a7c0316e84c5563e425db91b1aecc10e3c5837dc8cab51055ce136a6a0573221d35537a405ddd8a93f63c38a020241b05cc2ddeb7ef10ec3e1498a5c2cb9019502f90191050e8459682f008459682f0e8303629194a03167de1a56160e4647d77d81e9139af55b63d480b90124127b3be5000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000188f838e50431bf856b0a8a71e24f66f84842e5c00000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000001bc7e000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000c001a06e184c702d226214041254a7d7270566a76654e1ea55e7ab27282eebcd80f787a03ec805a679d440d6f191ad8ca28758f503cdc32f2f8ad31426e5e0203e8aeffeb8f302f8f005108459682f008459682f0e8303a9cf94a03167de1a56160e4647d77d81e9139af55b63d480b884ba7b8f130000000000000000000000000000000000000000000000000000000000000040000000000000000000000000fa4cb03c2a9ae6b8b381e891226532e0f62cb2d60000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000001b4efc001a036cfefa41f464f1f00ea7e4bdffff30904b9119ed80b40f2a98b25a2a90a33f0a03a07dda60c3c92ccad75d31b6ac6044906a39074178f4a34a9a5c298726d79cfb9019502f90191052d8459682f008459682f0e8303434b94a03167de1a56160e4647d77d81e9139af55b63d480b90124127b3be5000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000006e67893ca76452ceaa21a7069d98860d0e863794000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000016eca000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000c080a056a33d04515fb5e203df3c763542cc00d61afccb9d4c2171fb585e8ba25a683fa0183b80e51404188de8461abdcccd14d87f460feb6a8ae7a6744ef2d96c7d7be5b9013c02f90138054b8459682f008459682f0e8302fe0394e93c8cd0d409341205a592f8c4ac1a5fe5585cfa88016345785d8a0000b8c4e9e05c42000000000000000000000000b20a1c54842b558bfad4c14cdfb8ae1c79213c04000000000000000000000000000000000000000000000000016345785d8a000000000000000000000000000000000000000000000000000000000000000186a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000c080a041b62e522a2bb3c3c96c69460c61dc6ed74b184d5b2a59089ffce2006d3556e4a055f9fce471fcd567963f862b97f9d9bc95fff58dcc495639bb31c433e7c0b2a0b8b202f8af05568459682f008459682f0e82b8f594e011526dd07e17ac78b24fb0bed0095bdf3e903680b844095ea7b3000000000000000000000000d00ee8f0dbc9b8875f8840d6b7ab5d694ebe99ea00000000000000000000000000000000000000000000003635c9adc5dea00000c001a0e5297e30a2aa53dd4b9cc06641e3c82b88d3aefd66e6b33c3feb780f1ff0cc3fa01c1e7e6b40e0c028f2e6ce2aef6b6c5596958b1f69a494eea235dbb3a951bf46b8b302f8b005138459682f008459682f0d8301105694214f1893f54d51c106db828bece44fa93900854480b844a22cb465000000000000000000000000a03167de1a56160e4647d77d81e9139af55b63d40000000000000000000000000000000000000000000000000000000000000001c080a0da15112d20ea15a9ea7dde949865babd9cd66bb715cbb6b9d8e672a1d905d8d1a00525f7cad89fd1940c940fa640d2b9da39f780fe1ef5de0f6e7d05ca3f27bdcfb9019502f9019105348459682f008459682f0d8303434b94a03167de1a56160e4647d77d81e9139af55b63d480b90124127b3be5000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000f5478b31afc2b871cf37f12c35d12f9920260a98000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000018c510000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000c080a03a40659fd52c19e46e2e2fec0303543bbe086ba75f1fc88f915857cf98e5ce75a06717534f833dee4ed598cf3aa76a1d3061c5c2bbe184d957ea1908eb7f3049ceb87502f87205378459682f008459682f0d825208945e809a85aa182a9921edd10a4163745bb3e362848807021ed30b92939c80c001a0bec9d3611b43062c1891981f343f112b864be72437a341973187e16464b84606a00718a109817091a9df60b55352ce8cbfb5d9cfb90af5972131415976b403a3f4b8b302f8b005818b8459682f008459682f0d82bf7f94d56474d34a6a7b6c07d9c8e9535b658260bd315280b844095ea7b3000000000000000000000000fa6d8ee5be770f84fc001d098c4bd604fe01284a0000000000000000000000000000000000000000000000000de0b6b3a7640000c001a0650f55a1fe1e1c76f9efce5c982850b6225a64c94370564e477e8b2162472408a06bc55333608fb947dfcb59caf7416213b79f5eb1906c69e86112b17e29456955b8b302f8b00581e48459682f008459682f0d8255329468db1c8d85c09d546097c65ec7dcbff4d6497cbf80b84440c10f190000000000000000000000009874bee0854f2f1a17156d892b451cb07bf8e16200000000000000000000000000000000000000000000003635c9adc5dea00000c080a0b26b67eec7f7373b72d70af73595bb40c03536a5850a1edc7e89e856f910652fa02f4a8a7e2805d85a0dfcec29cb7b97ee5143969717a23ca8ce1e022b7ce57e16b9019702f901930582032b8459682f008459682f0d8303433994a03167de1a56160e4647d77d81e9139af55b63d480b90124127b3be5000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000820094b7942f39a635609c6268f7311e4c661d71000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000015af0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000c001a0dc37ae1c1583fa1827ed0ced0d826fa1d7d6fa2696db2ea84246ad5f21e77dd9a01740a44fe19ceda1816c692e26bcf056c9b8cbcf1d27fc462bba22bc0859452cb90ff902f90ff505820a5a8459682f008459682f0b830bb9568080b90f9a608060405260405162000eda38038062000eda83398101604081905262000026916200049d565b828162000036828260006200004d565b50620000449050826200008a565b505050620005d0565b6200005883620000e5565b600082511180620000665750805b1562000085576200008383836200012760201b620001791760201c565b505b505050565b7f7e644d79422f17c01e4894b5f4f588d331ebfa28653d42ae832dc59e38c9798f620000b562000156565b604080516001600160a01b03928316815291841660208301520160405180910390a1620000e2816200018f565b50565b620000f08162000244565b6040516001600160a01b038216907fbc7cd75a20ee27fd9adebab32041f755214dbc6bffa90cc0225b39da2e5c2d3b90600090a250565b60606200014f838360405180606001604052806027815260200162000eb360279139620002f8565b9392505050565b60006200018060008051602062000e9383398151915260001b6200037760201b620001a51760201c565b546001600160a01b0316919050565b6001600160a01b038116620001fa5760405162461bcd60e51b815260206004820152602660248201527f455243313936373a206e65772061646d696e20697320746865207a65726f206160448201526564647265737360d01b60648201526084015b60405180910390fd5b806200022360008051602062000e9383398151915260001b6200037760201b620001a51760201c565b80546001600160a01b0319166001600160a01b039290921691909117905550565b6200025a816200037a60201b620001a81760201c565b620002be5760405162461bcd60e51b815260206004820152602d60248201527f455243313936373a206e657720696d706c656d656e746174696f6e206973206e60448201526c1bdd08184818dbdb9d1c9858dd609a1b6064820152608401620001f1565b80620002237f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc60001b6200037760201b620001a51760201c565b6060600080856001600160a01b0316856040516200031791906200057d565b600060405180830381855af49150503d806000811462000354576040519150601f19603f3d011682016040523d82523d6000602084013e62000359565b606091505b5090925090506200036d8683838762000389565b9695505050505050565b90565b6001600160a01b03163b151590565b60608315620003fa578251620003f2576001600160a01b0385163b620003f25760405162461bcd60e51b815260206004820152601d60248201527f416464726573733a2063616c6c20746f206e6f6e2d636f6e74726163740000006044820152606401620001f1565b508162000406565b6200040683836200040e565b949350505050565b8151156200041f5781518083602001fd5b8060405162461bcd60e51b8152600401620001f191906200059b565b80516001600160a01b03811681146200045357600080fd5b919050565b634e487b7160e01b600052604160045260246000fd5b60005b838110156200048b57818101518382015260200162000471565b83811115620000835750506000910152565b600080600060608486031215620004b357600080fd5b620004be846200043b565b9250620004ce602085016200043b565b60408501519092506001600160401b0380821115620004ec57600080fd5b818601915086601f8301126200050157600080fd5b81518181111562000516576200051662000458565b604051601f8201601f19908116603f0116810190838211818310171562000541576200054162000458565b816040528281528960208487010111156200055b57600080fd5b6200056e8360208301602088016200046e565b80955050505050509250925092565b60008251620005918184602087016200046e565b9190910192915050565b6020815260008251806020840152620005bc8160408501602087016200046e565b601f01601f19169190910160400192915050565b6108b380620005e06000396000f3fe60806040523661001357610011610017565b005b6100115b61001f6101b7565b6001600160a01b0316336001600160a01b0316141561016f5760606001600160e01b031960003516631b2ce7f360e11b8114156100655761005e6101ea565b9150610167565b6001600160e01b0319811663278f794360e11b14156100865761005e610241565b6001600160e01b031981166308f2839760e41b14156100a75761005e610287565b6001600160e01b031981166303e1469160e61b14156100c85761005e6102b8565b6001600160e01b03198116635c60da1b60e01b14156100e95761005e6102f8565b60405162461bcd60e51b815260206004820152604260248201527f5472616e73706172656e745570677261646561626c6550726f78793a2061646d60448201527f696e2063616e6e6f742066616c6c6261636b20746f2070726f78792074617267606482015261195d60f21b608482015260a4015b60405180910390fd5b815160208301f35b61017761030c565b565b606061019e83836040518060600160405280602781526020016108576027913961031c565b9392505050565b90565b6001600160a01b03163b151590565b60007fb53127684a568b3173ae13b9f8a6016e243e63b6e8ee1178d6a717850b5d61035b546001600160a01b0316919050565b60606101f4610394565b600061020336600481846106a2565b81019061021091906106e8565b905061022d8160405180602001604052806000815250600061039f565b505060408051602081019091526000815290565b606060008061025336600481846106a2565b8101906102609190610719565b915091506102708282600161039f565b604051806020016040528060008152509250505090565b6060610291610394565b60006102a036600481846106a2565b8101906102ad91906106e8565b905061022d816103cb565b60606102c2610394565b60006102cc6101b7565b604080516001600160a01b03831660208201529192500160405160208183030381529060405291505090565b6060610302610394565b60006102cc610422565b610177610317610422565b610431565b6060600080856001600160a01b0316856040516103399190610807565b600060405180830381855af49150503d8060008114610374576040519150601f19603f3d011682016040523d82523d6000602084013e610379565b606091505b509150915061038a86838387610455565b9695505050505050565b341561017757600080fd5b6103a8836104d3565b6000825111806103b55750805b156103c6576103c48383610179565b505b505050565b7f7e644d79422f17c01e4894b5f4f588d331ebfa28653d42ae832dc59e38c9798f6103f46101b7565b604080516001600160a01b03928316815291841660208301520160405180910390a161041f81610513565b50565b600061042c6105bc565b905090565b3660008037600080366000845af43d6000803e808015610450573d6000f35b3d6000fd5b606083156104c15782516104ba576001600160a01b0385163b6104ba5760405162461bcd60e51b815260206004820152601d60248201527f416464726573733a2063616c6c20746f206e6f6e2d636f6e7472616374000000604482015260640161015e565b50816104cb565b6104cb83836105e4565b949350505050565b6104dc8161060e565b6040516001600160a01b038216907fbc7cd75a20ee27fd9adebab32041f755214dbc6bffa90cc0225b39da2e5c2d3b90600090a250565b6001600160a01b0381166105785760405162461bcd60e51b815260206004820152602660248201527f455243313936373a206e65772061646d696e20697320746865207a65726f206160448201526564647265737360d01b606482015260840161015e565b807fb53127684a568b3173ae13b9f8a6016e243e63b6e8ee1178d6a717850b5d61035b80546001600160a01b0319166001600160a01b039290921691909117905550565b60007f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc6101db565b8151156105f45781518083602001fd5b8060405162461bcd60e51b815260040161015e9190610823565b6001600160a01b0381163b61067b5760405162461bcd60e51b815260206004820152602d60248201527f455243313936373a206e657720696d706c656d656e746174696f6e206973206e60448201526c1bdd08184818dbdb9d1c9858dd609a1b606482015260840161015e565b807f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc61059b565b600080858511156106b257600080fd5b838611156106bf57600080fd5b5050820193919092039150565b80356001600160a01b03811681146106e357600080fd5b919050565b6000602082840312156106fa57600080fd5b61019e826106cc565b634e487b7160e01b600052604160045260246000fd5b6000806040838503121561072c57600080fd5b610735836106cc565b9150602083013567ffffffffffffffff8082111561075257600080fd5b818501915085601f83011261076657600080fd5b81358181111561077857610778610703565b604051601f8201601f19908116603f011681019083821181831017156107a0576107a0610703565b816040528281528860208487010111156107b957600080fd5b8260208601602083013760006020848301015280955050505050509250929050565b60005b838110156107f65781810151838201526020016107de565b838111156103c45750506000910152565b600082516108198184602087016107db565b9190910192915050565b60208152600082518060208401526108428160408501602087016107db565b601f01601f1916919091016040019291505056fe416464726573733a206c6f772d6c6576656c2064656c65676174652063616c6c206661696c6564a264697066735822122012bb4f564f73959a03513dc74fc3c6e40e8386e6f02c16b78d6db00ce0aa16af64736f6c63430008090033b53127684a568b3173ae13b9f8a6016e243e63b6e8ee1178d6a717850b5d6103416464726573733a206c6f772d6c6576656c2064656c65676174652063616c6c206661696c65640000000000000000000000007d01fb5f6d65d77b2c533b5cc89c71fd9ca8185b00000000000000000000000002322bcb34b045511bfb7dc29003d704c1d85fde00000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000024c4d66de8000000000000000000000000d3fa07fd66197ef36bcf882d6977d8cfced79a8200000000000000000000000000000000000000000000000000000000c080a0e35e62783355ebc717b172a39e51d699086bea5a9ea8b847b186773e39c3aaa4a046a8dbca0c9df0662ac49fcf85258cb5409045e6fa3603a46c17835cae632fe9b9021802f90214058301806a843b9aca00843b9acaee8301f5c694967056e49f0d877d2aa3baf2124dbce717dbc49d80b901a4a3f7a3a9000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000001000000000000000000000000ac78b912122bedbeb7b9deac9166b876c6792c890000000000000000000000000000000000000000000000000000000002faf0800000000000000000000000000000000000000000000000000000000000000001000000000000000000000000ac78b912122bedbeb7b9deac9166b876c6792c8900000000000000000000000000000000000000000000000000470de4df82000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000002f2177ff38dfeb4add65fa40764e77dbc19063a4000000000000000000000000ac78b912122bedbeb7b9deac9166b876c6792c890000000000000000000000000000000000000000000000000000000000000001c080a04f0e3914ffbf45389b416669a036870fa86b80d9916c7ffef10e54b2dd377788a0459752f0fc28c9a9d17b2c38d1ba0537d47edbbf5855c241034aa75cceabd133b87302f8700580843b9aca00843b9aca0b82520894517e1d171d16b9425959f78aa8c6152b2c859ce2865af3107a400080c080a061e8d215132665fce95112d0c851b0400fa3081f14ab285eb225549fcd62a40ba0075dbc6053f07c3d6e5b2a7ac7880503c2b0f7fa3f58b68d46447c6a5bf6b301b89e02f89b05108307a12084042e9216831e84808080b84440c10f1900000000000000000000000004cfced458e32a6d10d2c74ceca2528021b328be0000000000000000000000000000000000000000000000000000000005f5e100c080a0552483a0f8ecbf04a946f09bb56c03b05db0fa6e438a124e4cae43737bc60c5ea023641209dc55c44e0e6d818b2950ac497407cbfc6612805320add2c58967881ab89e02f89b05158307a12084042e9216831e84808080b84440c10f190000000000000000000000003097e1c66e9676d8cf59bfcb42c8afd9851fff770000000000000000000000000000000000000000000000000000000005f5e100c080a0f46eac8833fb98cf3426de60e795d072e53c597d971ca6a3075501e1ab462614a0412831ad8290df58c248db0dd4f765c2d88dfcca4a3308216e39200368bdeb35f9024b83252fad820f1e830bbd5094a658742d33ebd2ce2f0bdff73515aa797fd161d980b901e4252f7b01000000000000000000000000000000000000000000000000000000000000006e0000000000000000000000009f40916d0dfb2f8f5fb63d8f76826d09041f2eae0000000000000000000000000000000000000000000000000000000000030d404f1a7c36ccf53eea0d8b972ad4978be970573d2fb25e6ae4f9889c9830c8b6c94f1a7c36ccf53eea0d8b972ad4978be970573d2fb25e6ae4f9889c9830c8b6c900000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000f40000000000000000000000004d73adb72bc3dd368966edd0f0b2148401a178e2000000000000111d006e8a555e4fc287650f5e8ca1778a35dd44e893d6aa009a9f40916d0dfb2f8f5fb63d8f76826d09041f2eae000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000de0b6b3a764000000000000000000000000000000000000000000000000000000000000000000148c53c6a974a5f893ca5022de06cfba0c5d9a9eba0000000000000000000000000000000000000000000000002ea04640bc156a3543d987c68a788a9c8dbc0cd3c9275ff934c98cea7b4f25c8e323a0586cf54edd340b869a84c6911260b000c2babb45dac6c928716e4d1f0b88843dc0f90230e28401a6455583064d599459b0d71688da01057c08e4c1baa8faa629819c2a8337ea70e28401a6455683064d5a9459b0d71688da01057c08e4c1baa8faa629819c2a8336d612e28401a6455783064d5b9459b0d71688da01057c08e4c1baa8faa629819c2a8337924fe28401a6455883064d5c9459b0d71688da01057c08e4c1baa8faa629819c2a83371f95e28401a6455983064d5d9459b0d71688da01057c08e4c1baa8faa629819c2a8337f5afe28401a6455a83064d5e9459b0d71688da01057c08e4c1baa8faa629819c2a83391363e28401a6455b83064d5f9459b0d71688da01057c08e4c1baa8faa629819c2a8337ac9ee28401a6455c83064d609459b0d71688da01057c08e4c1baa8faa629819c2a8337f677e28401a6455d83064d619459b0d71688da01057c08e4c1baa8faa629819c2a8337c277e28401a6455e83064d629459b0d71688da01057c08e4c1baa8faa629819c2a8337c283e28401a6455f83064d639459b0d71688da01057c08e4c1baa8faa629819c2a83373c1ce28401a6456083064d649459b0d71688da01057c08e4c1baa8faa629819c2a833823bae28401a6456183064d659459b0d71688da01057c08e4c1baa8faa629819c2a83372791e28401a6456283064d669459b0d71688da01057c08e4c1baa8faa629819c2a8338a0b1e28401a6456383064d679459b0d71688da01057c08e4c1baa8faa629819c2a833839f8e28401a6456483064d689459b0d71688da01057c08e4c1baa8faa629819c2a833854c7")
	var block Block
	if err := rlp.DecodeBytes(blockRLP, &block); err != nil {
		t.Errorf("Failed to decode block: %v", err.Error())
		return
	}
}

// TestTransactionCoding tests serializing/de-serializing to/from rlp and JSON.
func TestTransactionCoding(t *testing.T) {
	key, err := crypto.GenerateKey()
	if err != nil {
		t.Fatalf("could not generate key: %v", err)
	}
	var (
		signer    = NewEIP2930Signer(big.NewInt(1))
		addr      = core.HexToAddress("0x0000000000000000000000000000000000000001")
		recipient = core.HexToAddress("095e7baea6a6c7c4c2dfeb977efac326af552d87")
		accesses  = AccessList{{Address: addr, StorageKeys: []core.Hash{{0}}}}
	)
	for i := uint64(0); i < 500; i++ {
		var txdata TxData
		switch i % 5 {
		case 0:
			// Legacy tx.
			txdata = &LegacyTx{
				Nonce:    i,
				To:       &recipient,
				Gas:      1,
				GasPrice: big.NewInt(2),
				Data:     []byte("abcdef"),
			}
		case 1:
			// Legacy tx contract creation.
			txdata = &LegacyTx{
				Nonce:    i,
				Gas:      1,
				GasPrice: big.NewInt(2),
				Data:     []byte("abcdef"),
			}
		case 2:
			// Tx with non-zero access list.
			txdata = &AccessListTx{
				ChainID:    big.NewInt(1),
				Nonce:      i,
				To:         &recipient,
				Gas:        123457,
				GasPrice:   big.NewInt(10),
				AccessList: accesses,
				Data:       []byte("abcdef"),
			}
		case 3:
			// Tx with empty access list.
			txdata = &AccessListTx{
				ChainID:  big.NewInt(1),
				Nonce:    i,
				To:       &recipient,
				Gas:      123457,
				GasPrice: big.NewInt(10),
				Data:     []byte("abcdef"),
			}
		case 4:
			// Contract creation with access list.
			txdata = &AccessListTx{
				ChainID:    big.NewInt(1),
				Nonce:      i,
				Gas:        123457,
				GasPrice:   big.NewInt(10),
				AccessList: accesses,
			}
		}
		tx, err := SignNewTx(key, signer, txdata)
		if err != nil {
			t.Fatalf("could not sign transaction: %v", err)
		}
		// RLP
		parsedTx, err := encodeDecodeBinary(tx)
		if err != nil {
			t.Fatal(err)
		}
		assertEqual(parsedTx, tx)

		// JSON
		parsedTx, err = encodeDecodeJSON(tx)
		if err != nil {
			t.Fatal(err)
		}
		assertEqual(parsedTx, tx)
	}
}

func encodeDecodeJSON(tx *Transaction) (*Transaction, error) {
	data, err := json.Marshal(tx)
	if err != nil {
		return nil, fmt.Errorf("json encoding failed: %v", err)
	}
	var parsedTx = &Transaction{}
	if err := json.Unmarshal(data, &parsedTx); err != nil {
		return nil, fmt.Errorf("json decoding failed: %v", err)
	}
	return parsedTx, nil
}

func encodeDecodeBinary(tx *Transaction) (*Transaction, error) {
	data, err := tx.MarshalBinary()
	if err != nil {
		return nil, fmt.Errorf("rlp encoding failed: %v", err)
	}
	var parsedTx = &Transaction{}
	if err := parsedTx.UnmarshalBinary(data); err != nil {
		return nil, fmt.Errorf("rlp decoding failed: %v", err)
	}
	return parsedTx, nil
}

func assertEqual(orig *Transaction, cpy *Transaction) error {
	// compare nonce, price, gaslimit, recipient, amount, payload, V, R, S
	if want, got := orig.Hash(), cpy.Hash(); want != got {
		return fmt.Errorf("parsed tx differs from original tx, want %v, got %v", want, got)
	}
	if want, got := orig.ChainId(), cpy.ChainId(); want.Cmp(got) != 0 {
		return fmt.Errorf("invalid chain id, want %d, got %d", want, got)
	}
	if orig.AccessList() != nil {
		if !reflect.DeepEqual(orig.AccessList(), cpy.AccessList()) {
			return fmt.Errorf("access list wrong!")
		}
	}
	return nil
}
